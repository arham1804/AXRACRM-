<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Axra Tutor CRM - A comprehensive system for managing tutoring leads and assignments">
    <meta name="theme-color" content="#5e35b1">
    <title>Axra Tutor CRM | {{ title }}</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Mobile webapp meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Axra Tutor">
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            {% if current_user.is_authenticated %}
            <div class="col-md-2 col-lg-2 d-md-block sidebar py-3">
                <div class="mb-4 px-3 d-flex align-items-center">
                    <a class="navbar-brand fs-4 text-royal-purple" href="{{ url_for('dashboard') }}">
                        <span class="text-royal-gold">Axra</span> Tutor
                    </a>
                    <button class="btn btn-sm btn-outline-secondary d-md-none ms-auto" id="mobileSidebarToggle" type="button">
                        <i data-feather="menu"></i>
                    </button>
                </div>
                <div class="px-3 mb-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-royal-purple text-white rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i data-feather="user" class="feather-sm"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 font-weight-bold">{{ current_user.name }}</h6>
                            <small class="text-muted">Administrator</small>
                        </div>
                    </div>
                </div>
                <ul class="nav flex-column" id="sidebarNav">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" 
                           href="{{ url_for('dashboard') }}">
                            <i data-feather="home"></i>
                            <span class="ms-2">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'student' in request.endpoint %}active{% endif %}" 
                           href="{{ url_for('student_leads') }}">
                            <i data-feather="users"></i>
                            <span class="ms-2">Student Leads</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'teacher' in request.endpoint and 'assign' not in request.endpoint %}active{% endif %}" 
                           href="{{ url_for('teachers') }}">
                            <i data-feather="user-check"></i>
                            <span class="ms-2">Teachers</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'assignment' in request.endpoint or 'assign' in request.endpoint %}active{% endif %}" 
                           href="{{ url_for('assignments') }}">
                            <i data-feather="clipboard"></i>
                            <span class="ms-2">Assignments</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'demo' in request.endpoint or 'feedback' in request.endpoint %}active{% endif %}" 
                           href="{{ url_for('demo_tracking') }}">
                            <i data-feather="calendar"></i>
                            <span class="ms-2">Demo Tracking</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'notifications' %}active{% endif %}" 
                           href="{{ url_for('notifications') }}">
                            <i data-feather="bell"></i>
                            <span class="ms-2">Notifications</span>
                            <span class="badge badge-pill bg-danger notification-counter position-absolute end-0 me-3">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'communication' in request.endpoint %}active{% endif %}" 
                           href="{{ url_for('communication_templates') }}">
                            <i data-feather="message-square"></i>
                            <span class="ms-2">Communication</span>
                        </a>
                    </li>
                    <li class="nav-item mt-5">
                        <a class="nav-link text-danger" href="{{ url_for('logout') }}">
                            <i data-feather="log-out"></i>
                            <span class="ms-2">Logout</span>
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
            
            <!-- Main content -->
            <main class="{% if current_user.is_authenticated %}col-md-10 col-lg-10 ms-sm-auto{% else %}col-12{% endif %} px-md-4 py-4">
                <!-- Top Navigation Bar with Notifications -->
                {% if current_user.is_authenticated %}
                <nav class="navbar navbar-dark gradient-purple mb-4 p-2 rounded shadow-sm">
                    <div class="container-fluid">
                        <span class="navbar-brand mb-0 h1">{{ title if title else 'Axra Tutor CRM' }}</span>
                        <div class="d-flex align-items-center">
                            <!-- Theme Toggle -->
                            <div class="me-3">
                                <button id="themeToggle" class="btn btn-outline-light" title="Toggle Dark/Light Mode">
                                    <i data-feather="moon"></i>
                                </button>
                            </div>
                            
                            <!-- Quick Actions Dropdown -->
                            <div class="dropdown me-3">
                                <a class="btn btn-outline-light position-relative" href="#" role="button" id="quickActionsDropdown" 
                                   data-bs-toggle="dropdown" aria-expanded="false">
                                    <i data-feather="more-horizontal"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="quickActionsDropdown">
                                    <li>
                                        <h6 class="dropdown-header">Quick Actions</h6>
                                    </li>
                                    <li><a class="dropdown-item" href="{{ url_for('student_form') }}">
                                        <i data-feather="user-plus" class="feather-sm me-2 text-primary"></i> Add New Student
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('teacher_form') }}">
                                        <i data-feather="user-check" class="feather-sm me-2 text-success"></i> Add New Teacher
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('demo_tracking') }}">
                                        <i data-feather="calendar" class="feather-sm me-2 text-warning"></i> Schedule Demo
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{{ url_for('quick_communication') }}">
                                        <i data-feather="send" class="feather-sm me-2 text-info"></i> Quick Communication
                                    </a></li>
                                </ul>
                            </div>
                            
                            <!-- Notifications Dropdown -->
                            <div class="dropdown me-3">
                                <a class="btn btn-outline-light position-relative" href="#" role="button" id="notificationDropdown" 
                                   data-bs-toggle="dropdown" aria-expanded="false">
                                    <i data-feather="bell"></i>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-counter">
                                        0
                                    </span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end notification-dropdown shadow-sm" aria-labelledby="notificationDropdown" 
                                    style="width: 350px; max-height: 400px; overflow-y: auto;">
                                    <li>
                                        <h6 class="dropdown-header d-flex justify-content-between align-items-center">
                                            Notifications
                                            <a href="{{ url_for('notifications') }}" class="btn btn-sm btn-link text-decoration-none">View All</a>
                                        </h6>
                                    </li>
                                    <div id="notification-items">
                                        <li class="text-center p-3">
                                            <div class="spinner-border spinner-border-sm text-royal-purple" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </li>
                                    </div>
                                </ul>
                            </div>
                            
                            <!-- Help Button -->
                            <div class="dropdown me-3">
                                <a class="btn btn-outline-light position-relative" href="#" role="button" id="helpDropdown"
                                   data-bs-toggle="dropdown" aria-expanded="false">
                                    <i data-feather="help-circle"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="helpDropdown">
                                    <li>
                                        <h6 class="dropdown-header">Need Help?</h6>
                                    </li>
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#keyboardShortcutsModal">
                                        <i data-feather="command" class="feather-sm me-2"></i> Keyboard Shortcuts
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#userGuideModal">
                                        <i data-feather="book-open" class="feather-sm me-2"></i> User Guide
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#contactSupportModal">
                                        <i data-feather="headphones" class="feather-sm me-2"></i> Contact Support
                                    </a></li>
                                </ul>
                            </div>
                            
                            <!-- User Info -->
                            <div class="dropdown">
                                <a class="btn btn-outline-light dropdown-toggle" href="#" role="button" id="userDropdown" 
                                   data-bs-toggle="dropdown" aria-expanded="false">
                                    <i data-feather="user"></i> {{ current_user.name }}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="userDropdown">
                                    <li>
                                        <h6 class="dropdown-header">Admin Account</h6>
                                    </li>
                                    <li><a class="dropdown-item" href="{{ url_for('dashboard') }}">
                                        <i data-feather="home" class="feather-sm me-2"></i> Dashboard
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#userProfileModal">
                                        <i data-feather="settings" class="feather-sm me-2"></i> Settings
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
                                        <i data-feather="log-out" class="feather-sm me-2"></i> Logout
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>
                {% endif %}
                
                <!-- Flash messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Page content -->
                {% block content %}{% endblock %}
                
                <!-- Footer -->
                <footer class="pt-4 mt-5 border-top">
                    <div class="row">
                        <div class="col-12 col-md">
                            <small class="d-block mb-3 text-muted">
                                &copy; {{ now.year }} Axra Tutor CRM. All rights reserved.
                            </small>
                        </div>
                    </div>
                </footer>
            </main>
        </div>
    </div>
    
    <!-- Toast container for notifications -->
    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    
    <!-- Keyboard Shortcuts Modal -->
    <div class="modal fade" id="keyboardShortcutsModal" tabindex="-1" aria-labelledby="keyboardShortcutsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header gradient-purple text-white">
                    <h5 class="modal-title" id="keyboardShortcutsModalLabel">Keyboard Shortcuts</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Shortcut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Dashboard</td>
                                <td><kbd>Alt</kbd> + <kbd>D</kbd></td>
                            </tr>
                            <tr>
                                <td>Student Leads</td>
                                <td><kbd>Alt</kbd> + <kbd>S</kbd></td>
                            </tr>
                            <tr>
                                <td>Teachers</td>
                                <td><kbd>Alt</kbd> + <kbd>T</kbd></td>
                            </tr>
                            <tr>
                                <td>Assignments</td>
                                <td><kbd>Alt</kbd> + <kbd>A</kbd></td>
                            </tr>
                            <tr>
                                <td>Notifications</td>
                                <td><kbd>Alt</kbd> + <kbd>N</kbd></td>
                            </tr>
                            <tr>
                                <td>Search</td>
                                <td><kbd>/</kbd></td>
                            </tr>
                            <tr>
                                <td>Toggle Dark Mode</td>
                                <td><kbd>Alt</kbd> + <kbd>M</kbd></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Guide Modal -->
    <div class="modal fade" id="userGuideModal" tabindex="-1" aria-labelledby="userGuideModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header gradient-purple text-white">
                    <h5 class="modal-title" id="userGuideModalLabel">User Guide</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="userGuideTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                                Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="leads-tab" data-bs-toggle="tab" data-bs-target="#leads" type="button">
                                Student Leads
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="teachers-tab" data-bs-toggle="tab" data-bs-target="#teachers" type="button">
                                Teachers
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" type="button">
                                Assignments
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content py-3" id="userGuideTabContent">
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <h5>Welcome to Axra Tutor CRM</h5>
                            <p>This CRM system helps you manage student leads, teachers, assignments, and demos for your tutoring business.</p>
                            <p>Key features include:</p>
                            <ul>
                                <li>Student lead management</li>
                                <li>Teacher profile management</li>
                                <li>Intelligent teacher-student matching</li>
                                <li>Demo scheduling and tracking</li>
                                <li>Communication templates and notifications</li>
                                <li>Performance analytics dashboard</li>
                            </ul>
                        </div>
                        <div class="tab-pane fade" id="leads" role="tabpanel">
                            <h5>Managing Student Leads</h5>
                            <p>Student leads are potential customers who have expressed interest in tutoring services.</p>
                            <ol>
                                <li>Add new leads via the "Add Student Lead" button</li>
                                <li>View all leads in the Student Leads section</li>
                                <li>Use the match feature to find suitable teachers</li>
                                <li>Track lead status (New, Assigned, Converted, Lost)</li>
                            </ol>
                        </div>
                        <div class="tab-pane fade" id="teachers" role="tabpanel">
                            <h5>Managing Teachers</h5>
                            <p>Register and manage all tutors in your network.</p>
                            <ol>
                                <li>Add new teachers via the "Add Teacher" button</li>
                                <li>Record their qualifications, experience, and availability</li>
                                <li>Specify preferred subjects and areas</li>
                                <li>View teacher performance metrics</li>
                            </ol>
                        </div>
                        <div class="tab-pane fade" id="assignments" role="tabpanel">
                            <h5>Handling Assignments</h5>
                            <p>Assignments connect students with teachers for tutoring sessions.</p>
                            <ol>
                                <li>Assign teachers to student leads</li>
                                <li>Schedule demo classes</li>
                                <li>Record feedback after demos</li>
                                <li>Track conversion from demo to regular tutoring</li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contact Support Modal -->
    <div class="modal fade" id="contactSupportModal" tabindex="-1" aria-labelledby="contactSupportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header gradient-purple text-white">
                    <h5 class="modal-title" id="contactSupportModalLabel">Contact Support</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="supportForm">
                        <div class="mb-3">
                            <label for="supportSubject" class="form-label">Subject</label>
                            <select class="form-select" id="supportSubject" required>
                                <option value="" selected disabled>Select a topic</option>
                                <option value="Technical Issue">Technical Issue</option>
                                <option value="Feature Request">Feature Request</option>
                                <option value="Account Help">Account Help</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="supportMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="supportMessage" rows="5" required></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn gradient-purple">Submit</button>
                        </div>
                    </form>
                    <div id="supportFormSuccess" class="alert alert-success mt-3 d-none">
                        Your support request has been submitted. Our team will get back to you soon.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Profile/Settings Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header gradient-purple text-white">
                    <h5 class="modal-title" id="userProfileModalLabel">Account Settings</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="bg-royal-purple text-white rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                                <i data-feather="user" style="width: 32px; height: 32px;"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-0">{{ current_user.name }}</h5>
                            <p class="text-muted mb-0">{{ current_user.email }}</p>
                        </div>
                    </div>
                    
                    <ul class="nav nav-tabs" id="userProfileTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button">
                                Profile
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button">
                                Password
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button">
                                Preferences
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content py-3" id="userProfileTabContent">
                        <div class="tab-pane fade show active" id="profile" role="tabpanel">
                            <form id="profileForm">
                                <div class="mb-3">
                                    <label for="profileName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="profileName" value="{{ current_user.name }}">
                                </div>
                                <div class="mb-3">
                                    <label for="profileEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="profileEmail" value="{{ current_user.email }}" readonly>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn gradient-purple">Save Changes</button>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="password" role="tabpanel">
                            <form id="passwordForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirmPassword" required>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn gradient-purple">Change Password</button>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="preferences" role="tabpanel">
                            <form id="preferencesForm">
                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="darkModePreference" checked>
                                    <label class="form-check-label" for="darkModePreference">Dark Mode</label>
                                </div>
                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                    <label class="form-check-label" for="emailNotifications">Email Notifications</label>
                                </div>
                                <div class="mb-3">
                                    <label for="notificationFrequency" class="form-label">Notification Frequency</label>
                                    <select class="form-select" id="notificationFrequency">
                                        <option value="immediate">Immediate</option>
                                        <option value="daily">Daily Digest</option>
                                        <option value="weekly">Weekly Digest</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn gradient-purple">Save Preferences</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Global Search Modal -->
    <div class="modal fade" id="globalSearchModal" tabindex="-1" aria-labelledby="globalSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header gradient-purple text-white">
                    <h5 class="modal-title" id="globalSearchModalLabel">Search</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-light border-0"><i data-feather="search" class="text-muted"></i></span>
                        <input type="text" class="form-control border-0 shadow-none" id="globalSearchInput" placeholder="Search students, teachers, or assignments..." autofocus>
                    </div>
                    <div id="globalSearchResults" class="mt-3">
                        <!-- Search results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Initialize Feather Icons -->
    <script>
        feather.replace();
    </script>
    
    <!-- Theme Toggle Script -->
    <script>
        $(document).ready(function() {
            // Check for saved theme preference or default to dark mode
            const currentTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(currentTheme);
            
            // Update the toggle button icon
            updateThemeIcon(currentTheme);
            
            // Theme toggle button click handler
            $('#themeToggle').click(function() {
                const currentTheme = $('body').hasClass('dark-mode') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                applyTheme(newTheme);
                updateThemeIcon(newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Update preference in settings modal if open
                $('#darkModePreference').prop('checked', newTheme === 'dark');
            });
            
            // Settings modal preference change
            $('#darkModePreference').change(function() {
                const newTheme = $(this).is(':checked') ? 'dark' : 'light';
                
                applyTheme(newTheme);
                updateThemeIcon(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            // Function to apply theme
            function applyTheme(theme) {
                if (theme === 'dark') {
                    $('body').addClass('dark-mode');
                    $('.card').addClass('bg-dark text-light border-secondary');
                    $('.table').addClass('table-dark');
                    $('.modal-content').addClass('bg-dark text-light');
                    $('.form-control, .form-select').addClass('bg-secondary text-light border-dark');
                } else {
                    $('body').removeClass('dark-mode');
                    $('.card').removeClass('bg-dark text-light border-secondary');
                    $('.table').removeClass('table-dark');
                    $('.modal-content').removeClass('bg-dark text-light');
                    $('.form-control, .form-select').removeClass('bg-secondary text-light border-dark');
                }
            }
            
            // Function to update theme toggle icon
            function updateThemeIcon(theme) {
                const icon = theme === 'dark' ? 'sun' : 'moon';
                $('#themeToggle').find('svg').remove();
                $('#themeToggle').prepend(feather.icons[icon].toSvg());
                feather.replace();
            }
        });
    </script>
    
    <!-- Keyboard Shortcuts Script -->
    <script>
        $(document).ready(function() {
            // Keyboard shortcuts
            $(document).keydown(function(e) {
                // Skip if inside input fields
                if ($(e.target).is('input, textarea, select')) return;
                
                // Alt + key shortcuts
                if (e.altKey) {
                    switch(e.key.toLowerCase()) {
                        case 'd': // Dashboard
                            window.location.href = "{{ url_for('dashboard') }}";
                            break;
                        case 's': // Student Leads
                            window.location.href = "{{ url_for('student_leads') }}";
                            break;
                        case 't': // Teachers
                            window.location.href = "{{ url_for('teachers') }}";
                            break;
                        case 'a': // Assignments
                            window.location.href = "{{ url_for('assignments') }}";
                            break;
                        case 'n': // Notifications
                            window.location.href = "{{ url_for('notifications') }}";
                            break;
                        case 'm': // Toggle dark mode
                            $('#themeToggle').click();
                            break;
                    }
                } else if (e.key === '/') { // Global search
                    e.preventDefault();
                    $('#globalSearchModal').modal('show');
                    setTimeout(() => {
                        $('#globalSearchInput').focus();
                    }, 500);
                }
            });
            
            // Global search functionality
            $('#globalSearchInput').on('keyup', function() {
                const query = $(this).val().trim().toLowerCase();
                if (query.length < 2) {
                    $('#globalSearchResults').html('');
                    return;
                }
                
                // Show loading indicator
                $('#globalSearchResults').html('<div class="text-center p-3"><div class="spinner-border spinner-border-sm text-royal-purple" role="status"></div></div>');
                
                // Simulate search (replace with actual AJAX call to search API)
                setTimeout(function() {
                    // This is a placeholder until we implement actual search - will be replaced with real API call
                    const mockResults = `
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Students</h6>
                                </div>
                                <a href="#" class="list-group-item list-group-item-action">
                                    <i data-feather="user" class="feather-sm me-2"></i> Rahul Singh
                                </a>
                                <a href="#" class="list-group-item list-group-item-action">
                                    <i data-feather="user" class="feather-sm me-2"></i> Rajat Kumar
                                </a>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Teachers</h6>
                                </div>
                                <a href="#" class="list-group-item list-group-item-action">
                                    <i data-feather="user-check" class="feather-sm me-2"></i> Rahul Sharma
                                </a>
                            </div>
                        </div>
                    `;
                    
                    $('#globalSearchResults').html(mockResults);
                    feather.replace();
                }, 500);
            });
            
            // Support form submission
            $('#supportForm').submit(function(e) {
                e.preventDefault();
                
                // Simulate form submission (to be replaced with actual API call)
                $(this).addClass('d-none');
                $('#supportFormSuccess').removeClass('d-none');
                
                // Reset and close after delay
                setTimeout(function() {
                    $('#supportForm').removeClass('d-none').trigger('reset');
                    $('#supportFormSuccess').addClass('d-none');
                    $('#contactSupportModal').modal('hide');
                }, 3000);
            });
            
            // Profile form submission
            $('#profileForm').submit(function(e) {
                e.preventDefault();
                
                // Simulate form submission (to be replaced with actual API call)
                showToast('Profile updated successfully!');
                $('#userProfileModal').modal('hide');
            });
            
            // Password form submission
            $('#passwordForm').submit(function(e) {
                e.preventDefault();
                
                // Validate password match
                const newPass = $('#newPassword').val();
                const confirmPass = $('#confirmPassword').val();
                
                if (newPass !== confirmPass) {
                    showToast('Passwords do not match!', 'error');
                    return;
                }
                
                // Simulate form submission (to be replaced with actual API call)
                showToast('Password changed successfully!');
                $(this).trigger('reset');
                $('#userProfileModal').modal('hide');
            });
            
            // Preferences form submission
            $('#preferencesForm').submit(function(e) {
                e.preventDefault();
                
                // Save preferences
                const darkMode = $('#darkModePreference').is(':checked');
                const emailNotifs = $('#emailNotifications').is(':checked');
                const notifFreq = $('#notificationFrequency').val();
                
                localStorage.setItem('theme', darkMode ? 'dark' : 'light');
                localStorage.setItem('emailNotifications', emailNotifs);
                localStorage.setItem('notificationFrequency', notifFreq);
                
                // Apply theme if changed
                const currentTheme = $('body').hasClass('dark-mode') ? 'dark' : 'light';
                const newTheme = darkMode ? 'dark' : 'light';
                
                if (currentTheme !== newTheme) {
                    applyTheme(newTheme);
                    updateThemeIcon(newTheme);
                }
                
                // Simulate form submission
                showToast('Preferences saved successfully!');
                $('#userProfileModal').modal('hide');
            });
        });
    </script>
    
    <!-- Custom Scripts -->
    <script src="{{ url_for('static', filename='js/formValidation.js') }}"></script>

    <!-- Mobile sidebar toggle -->
    <script>
        $(document).ready(function() {
            // Mobile sidebar toggle
            $('#mobileSidebarToggle').click(function() {
                $('#sidebarNav').toggleClass('show');
                
                // Toggle icon between menu and x
                var icon = $(this).find('svg').attr('data-feather');
                var newIcon = icon === 'menu' ? 'x' : 'menu';
                
                $(this).find('svg').remove();
                $(this).prepend(feather.icons[newIcon].toSvg());
                feather.replace();
            });
            
            // Close sidebar when clicking on a link (for mobile)
            $('#sidebarNav .nav-link').click(function() {
                if ($(window).width() < 768) {
                    $('#sidebarNav').removeClass('show');
                    $('#mobileSidebarToggle').find('svg').remove();
                    $('#mobileSidebarToggle').prepend(feather.icons['menu'].toSvg());
                    feather.replace();
                }
            });
        });
    </script>
    
    <!-- Notification Scripts -->
    <script>
        $(document).ready(function() {
            // Function to fetch and update notifications
            function fetchNotifications() {
                $.get('/api/notifications/unread', function(data) {
                    // Update counter
                    $('.notification-counter').text(data.count);
                    
                    // Update dropdown content
                    let notificationHtml = '';
                    
                    if (data.notifications.length === 0) {
                        notificationHtml = `
                            <li class="text-center p-3">
                                <span class="text-muted">No new notifications</span>
                            </li>
                        `;
                    } else {
                        // Sort notifications - urgent first
                        data.notifications.sort((a, b) => {
                            if (a.is_urgent && !b.is_urgent) return -1;
                            if (!a.is_urgent && b.is_urgent) return 1;
                            return new Date(b.created_at) - new Date(a.created_at);
                        });
                        
                        $.each(data.notifications, function(i, notification) {
                            if (i >= 5) return false; // Show only 5 notifications in dropdown
                            
                            const iconClass = notification.is_urgent ? 'text-danger' : 'text-primary';
                            const icon = notification.is_urgent ? 'alert-circle' : 'bell';
                            
                            notificationHtml += `
                                <li>
                                    <a class="dropdown-item py-2 border-bottom" href="{{ url_for('notifications') }}">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <i data-feather="${icon}" class="${iconClass}"></i>
                                            </div>
                                            <div class="notification-content">
                                                <div class="fw-bold">${notification.title}</div>
                                                <div class="small text-muted">${notification.message.length > 60 ? notification.message.substring(0, 60) + '...' : notification.message}</div>
                                                <div class="small text-muted">${notification.created_at}</div>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                            `;
                        });
                        
                        if (data.notifications.length > 5) {
                            notificationHtml += `
                                <li>
                                    <div class="text-center p-2">
                                        <a href="{{ url_for('notifications') }}" class="btn btn-sm btn-primary">
                                            View all ${data.count} notifications
                                        </a>
                                    </div>
                                </li>
                            `;
                        }
                    }
                    
                    $('#notification-items').html(notificationHtml);
                    feather.replace(); // Re-initialize feather icons
                });
            }
            
            // Initial fetch
            fetchNotifications();
            
            // Refresh every 30 seconds
            setInterval(fetchNotifications, 30000);
            
            // Update when dropdown is opened
            $('#notificationDropdown').on('show.bs.dropdown', function() {
                fetchNotifications();
            });
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
